# üß± Junie Task Document 03 ‚Äî Cloud Logging Integration
**Date:** 2025-10-28  
**Group:** Cloud Logging Integration  
**Scope:** Implement Google Cloud Logging sync for audit events generated by the Compliance Kernel. Enables immutable external audit mirroring and cross-verification of hash integrity.  
**Phases Covered:** Phase 5

---

## [JUNIE TASK 10]
**Title:** Implement GCP Logging Utility

**Preconditions:**
- Service Account JSON uploaded to Render (`/etc/agent_factory/service-account.json`).
- `GOOGLE_APPLICATION_CREDENTIALS` and `GCP_PROJECT_ID` set in env.
- Governance Middleware and Compliance Kernel active.

**Plan:**
1. Create `/src/agent_factory/utils/gcp_logging.py`.
2. Add async `push_log_async()` function to stream events to Cloud Logging.
3. Integrate into `log_event()`.

**Edits:**
```python
# /src/agent_factory/utils/gcp_logging.py
import asyncio
from google.cloud import logging_v2
import os

_client = None

def get_gcp_logger():
    global _client
    if not _client:
        _client = logging_v2.Client(project=os.getenv('GCP_PROJECT_ID'))
    return _client.logger(os.getenv('LOG_NAME', 'compliance-kernel-audit'))

async def push_log_async(event: dict):
    logger = get_gcp_logger()
    loop = asyncio.get_event_loop()
    await loop.run_in_executor(None, logger.log_struct, event)
```

**Integration:**
```python
# /src/agent_factory/utils/compliance_kernel.py
from src.agent_factory.utils.gcp_logging import push_log_async
import asyncio

def log_event(component: str, action: str, actor: str, target_id: str, details: dict = None):
    db = get_session()
    event = {
        'component': component,
        'action': action,
        'actor': actor,
        'target_id': target_id,
        'details': details or {},
        'timestamp': datetime.utcnow().isoformat()
    }
    event_hash = compute_event_hash(event)
    record = AuditLog(
        component=component,
        action=action,
        actor=actor,
        actor_type='system' if actor.startswith('agent_') else 'human',
        phase='Governance Kernel',
        target_id=target_id,
        details=details,
        hash=event_hash,
        sync_status='local'
    )
    db.add(record)
    db.commit()
    asyncio.create_task(push_log_async(event))
    return event_hash
```

**Tests:**
```bash
pytest tests/test_gcp_logging.py
```

**Verification:**
- Event logs appear in GCP ‚Üí Logging Explorer within 5s.
- Each event hash matches local record.

**Rollback:**
Remove imports and `push_log_async()` calls from `compliance_kernel.py`.

---

## [JUNIE TASK 11]
**Title:** Create GCP Logging Validation CLI

**Preconditions:** GCP client functional.

**Plan:**
1. Add `/scripts/gcp_audit_validator.py`.
2. Compare local audit hashes with GCP logs.

**Edits:**
```python
# /scripts/gcp_audit_validator.py
import click, os
from google.cloud import logging_v2
from src.agent_factory.database import get_session
from src.agent_factory.models.hitl_schema import AuditLog

@click.group()
def cli():
    pass

@cli.command()
def compare_hashes():
    project = os.getenv('GCP_PROJECT_ID')
    client = logging_v2.Client(project=project)
    logger_name = os.getenv('LOG_NAME', 'compliance-kernel-audit')
    logs = list(client.list_entries(filter_=f"logName=projects/{project}/logs/{logger_name}", page_size=50))

    db = get_session()
    local_hashes = {log.hash for log in db.query(AuditLog).all()}
    gcp_hashes = {e.payload.get('hash') for e in logs if hasattr(e, 'payload')}

    missing = local_hashes - gcp_hashes
    print(f"Local entries: {len(local_hashes)}, GCP entries: {len(gcp_hashes)}")
    if missing:
        print(f"‚ö†Ô∏è  Missing {len(missing)} entries in GCP:")
        for m in list(missing)[:10]:
            print(f" - {m}")
    else:
        print("‚úÖ All hashes synchronized.")

if __name__ == '__main__':
    cli()
```

**Tests:**
```bash
python scripts/gcp_audit_validator.py compare_hashes
```

**Verification:**
- CLI displays synchronization stats.
- No missing hashes between DB and GCP.

**Rollback:** Delete script.

---

## [JUNIE TASK 12]
**Title:** Configure GCP IAM and Secret Injection for Render

**Preconditions:** Render service and GCP project ready.

**Plan:**
1. Create service account `compliance-logger`.
2. Assign role `roles/logging.logWriter`.
3. Generate JSON key and upload to Render secrets.

**Commands:**
```bash
gcloud iam service-accounts create compliance-logger \
  --display-name "Compliance Kernel Logger"

gcloud projects add-iam-policy-binding $GCP_PROJECT_ID \
  --member="serviceAccount:compliance-logger@$GCP_PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/logging.logWriter"

gcloud iam service-accounts keys create service-account.json \
  --iam-account=compliance-logger@$GCP_PROJECT_ID.iam.gserviceaccount.com
```

Upload to Render and set:
```
GOOGLE_APPLICATION_CREDENTIALS=/etc/agent_factory/service-account.json
GCP_PROJECT_ID=agent-factory-prod
LOG_NAME=compliance-kernel-audit
```

**Verification:**
- Cloud logs visible in Logging Explorer.
- Service account permissions verified.

**Rollback:**
Delete service account:
```bash
gcloud iam service-accounts delete compliance-logger@$GCP_PROJECT_ID.iam.gserviceaccount.com
```

---

‚úÖ **End of Document 03 ‚Äî Cloud Logging Integration**